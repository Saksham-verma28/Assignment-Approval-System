<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Department List</title>
  <link rel="stylesheet" href="/css/departmentList.css">
  <link rel="stylesheet" href="/css/sidebar.css">
  <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>

  <%- include('../partials/sidebar') %>

  <main id="main-content">
    <h1>All Departments</h1>

    <% if (typeof success !== 'undefined' && success === 'updated') { %>
      <div class="success-msg">‚úÖ Department updated successfully!</div>
    <% } else if (typeof success !== 'undefined' && success === 'deleted') { %>
      <div class="success-msg" style="background:#EF4444;">üóëÔ∏è Department deleted successfully!</div>
    <% } %>

    <form id="department-filters-form" class="controls-bar" method="post" action="/admin/department/search">
      <div class="search-container">
        <label for="search-input" class="control-label">Search</label>
        <input type="text" id="search-input" name="search" placeholder="Search by department name">
      </div>

      <div class="filter-container">
        <label for="filter-select" class="control-label">Filter by Type</label>
        <div class="select-wrapper">
          <select id="filter-select" name="program_type">
            <option value="all">All</option>
            <option value="UG">Undergraduate (UG)</option>
            <option value="PG">Postgraduate (PG)</option>
            <option value="Research">Research</option>
          </select>
        </div>
      </div>
    </form>

    <table>
      <thead>
        <tr>
          <th>Department Name</th>
          <th>Program Type</th>
          <th>Department Address</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        <% if (department && department.length > 0) { %>
          <% department.forEach(d => { %>
            <tr>
              <td><%= d.department_name %></td>
              <td><%= d.program_type %></td>
              <td><%= d.department_address %></td>
              <td>
                <button 
                  class="edit-btn" 
                  data-id="<%= d._id %>"
                  data-name="<%= d.department_name %>" 
                  data-type="<%= d.program_type %>" 
                  data-address="<%= d.department_address %>">
                  Edit
                </button>
                <button 
                  class="delete-btn"
                  data-id="<%= d._id %>"
                  data-name="<%= d.department_name %>">
                  Delete
                </button>
              </td>
            </tr>
          <% }) %>
        <% } else { %>
          <tr>
            <td colspan="4" style="text-align:center;">No departments found.</td>
          </tr>
        <% } %>
      </tbody>
    </table>
  </main>

  <!-- ‚úÖ Edit Popup -->
  <div class="popup-overlay" id="editPopup">
    <div class="popup">
      <h2>Edit Department</h2>
      <form id="editForm" method="post" action="/admin/department/update">
        <input type="hidden" id="editId" name="id">

        <label>Department Name</label>
        <input type="text" id="editName" name="department_name" required>

        <label>Program Type</label>
        <select id="editType" name="program_type" required>
          <option value="UG">Undergraduate (UG)</option>
          <option value="PG">Postgraduate (PG)</option>
          <option value="Research">Research</option>
        </select>

        <label>Department Address</label>
        <input type="text" id="editAddress" name="department_address" required>

        <div class="btn-row">
          <button type="submit">Save Changes</button>
          <button type="button" class="cancel-btn" id="cancelEdit">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <div class="popup-overlay" id="deletePopup">
    <div class="popup">
      <h2>Confirm Deletion</h2>
      <p id="deleteMessage" style="text-align:center;">Are you sure you want to delete this department?</p>
      <div class="btn-row">
        <button class="delete-confirm" id="confirmDelete">Delete Department</button>
        <button class="cancel-btn" id="cancelDelete">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    const editBtns = document.querySelectorAll('.edit-btn');
    const deleteBtns = document.querySelectorAll('.delete-btn');
    const popupEdit = document.getElementById('editPopup');
    const popupDelete = document.getElementById('deletePopup');
    const cancelEdit = document.getElementById('cancelEdit');
    const cancelDelete = document.getElementById('cancelDelete');
    const confirmDelete = document.getElementById('confirmDelete');
    let deleteId = "";

    // üü£ Edit Popup
    editBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        document.getElementById('editId').value = btn.dataset.id;
        document.getElementById('editName').value = btn.dataset.name;
        document.getElementById('editType').value = btn.dataset.type;
        document.getElementById('editAddress').value = btn.dataset.address;
        popupEdit.style.display = 'flex';
      });
    });

    cancelEdit.addEventListener('click', () => {
      popupEdit.style.display = 'none';
    });

    // üóëÔ∏è Delete Popup
    deleteBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        deleteId = btn.dataset.id;
        document.getElementById('deleteMessage').innerText = 
          `Are you sure you want to delete the "${btn.dataset.name}" department?`;
        popupDelete.style.display = 'flex';
      });
    });

    cancelDelete.addEventListener('click', () => {
      popupDelete.style.display = 'none';
    });

    confirmDelete.addEventListener('click', () => {
      window.location.href = `/admin/department/delete?id=${deleteId}`;
    });

    // Close popups on outside click
    window.addEventListener('click', (e) => {
      if (e.target === popupEdit) popupEdit.style.display = 'none';
      if (e.target === popupDelete) popupDelete.style.display = 'none';
    });
  </script>

  <script src="/js/active.js"></script>
</body>
</html>
